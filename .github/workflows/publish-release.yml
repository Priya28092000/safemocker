# Publish Release
# Publishes npm package and creates GitHub Release when a version tag is pushed
#
# **What it does:**
# 1. Extracts version from tag (e.g., v0.1.1 â†’ 0.1.1)
# 2. Verifies package.json version matches tag version
# 3. Builds the project
# 4. Runs tests
# 5. Publishes to npm (using trusted publishing/OIDC)
# 6. Extracts changelog section for the version
# 7. Creates GitHub Release with changelog
#
# **Triggers:**
# - Tag push matching v*.*.* pattern (automatic, triggered by version-bump.yml)
# - Manual workflow_dispatch (with tag input for re-publishing)
#
# **npm Trusted Publishing Requirements:**
# CRITICAL: This workflow filename (publish-release.yml) MUST exactly match the
# workflow filename configured in npm trusted publisher settings.
# 
# Required npm trusted publisher configuration:
# - Organization/User: JSONbored
# - Repository: safemocker (or JSONbored/safemocker)
# - Workflow filename: publish-release.yml (must match this file name exactly)
#
# See: https://docs.npmjs.com/trusted-publishers/
# Documentation: .cursor/npm-trusted-publishing-setup.md
name: Publish Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'  # Triggers on version tags (e.g., v0.1.0, v1.2.3)
      - 'v*.*.*'  # Fallback pattern for broader matching
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag name (e.g., v0.1.1)'
        required: true
        type: string

jobs:
  publish-release:
    name: Publish to npm and create GitHub release
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    permissions:
      id-token: write  # Required for OIDC (npm trusted publishing)
      contents: write  # Required to create GitHub releases
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          # Full history needed for changelog extraction
          fetch-depth: 0
          # For manual trigger, checkout the specified tag; for tag push, use the tag ref
          ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.ref }}
      
      - name: Extract version from tag
        id: version
        run: |
          set -e  # Exit on error
          
          echo "ðŸ” DEBUG: Extracting version from tag..."
          
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # Manual trigger: extract from input tag
            TAG="${{ github.event.inputs.tag }}"
            echo "ðŸ” DEBUG: Manual trigger with tag: $TAG"
          else
            # Tag push: extract from GITHUB_REF (e.g., refs/tags/v0.1.1)
            TAG="${GITHUB_REF#refs/tags/}"
            echo "ðŸ” DEBUG: Tag push detected: $TAG"
          fi
          
          # Remove 'v' prefix from tag (e.g., "v0.1.1" â†’ "0.1.1")
          VERSION="${TAG#v}"
          
          # Validate version matches semver pattern
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "âŒ Error: Invalid version format '$VERSION' (from tag '$TAG')" >&2
            echo "Expected format: v0.1.1 or 0.1.1" >&2
            exit 1
          fi
          
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "TAG=$TAG" >> $GITHUB_OUTPUT
          echo "âœ… Extracted version: $VERSION from tag: $TAG"

      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: '24'
          registry-url: 'https://registry.npmjs.org'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build project
        run: pnpm build --if-present

      - name: Run tests
        run: pnpm test

      - name: Verify package.json version matches tag
        run: |
          set -e  # Exit on error
          
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          TAG_VERSION="${{ steps.version.outputs.VERSION }}"
          
          echo "ðŸ” DEBUG: package.json version: $PACKAGE_VERSION"
          echo "ðŸ” DEBUG: Tag version: $TAG_VERSION"
          
          if [ "$PACKAGE_VERSION" != "$TAG_VERSION" ]; then
            echo "âŒ Error: package.json version ($PACKAGE_VERSION) does not match tag version ($TAG_VERSION)." >&2
            echo "This usually means the version-bump workflow didn't complete successfully." >&2
            exit 1
          fi
          
          echo "âœ… package.json version matches tag version."

      - name: Publish to npm
        run: |
          set -e  # Exit on error
          
          VERSION="${{ steps.version.outputs.VERSION }}"
          
          echo "ðŸ” DEBUG: Publishing @jsonbored/safemocker@$VERSION to npm..."
          echo "ðŸ” DEBUG: Using npm trusted publishing (OIDC)"
          echo "ðŸ” DEBUG: npm version: $(npm --version)"
          echo "ðŸ” DEBUG: Repository: ${{ github.repository }}"
          echo "ðŸ” DEBUG: Workflow file: publish-release.yml"
          
          # According to official npm docs (https://docs.npmjs.com/trusted-publishers):
          # - npm CLI automatically detects OIDC environments when:
          #   1. id-token: write permission is set (âœ“ configured)
          #   2. registry-url is set in setup-node (âœ“ configured)
          #   3. No NODE_AUTH_TOKEN is provided (âœ“ not provided)
          # - Provenance is automatically generated (no --provenance flag needed)
          # - Just run: npm publish
          # - For scoped packages, --access public is required
          
          # Verify npm version supports trusted publishing (requires >= 11.5.1)
          NPM_VERSION=$(npm --version)
          echo "âœ… npm version $NPM_VERSION (trusted publishing requires >= 11.5.1)"
          
          # Publish using trusted publishing
          # The npm CLI will automatically:
          # 1. Detect OIDC environment
          # 2. Use OIDC token for authentication
          # 3. Generate provenance attestation automatically
          if ! npm publish --access public; then
            echo "" >&2
            echo "âŒ Error: npm publish failed" >&2
            echo "" >&2
            echo "ðŸ” TROUBLESHOOTING: npm trusted publishing configuration" >&2
            echo "" >&2
            echo "According to npm docs, verify the following in npm trusted publisher settings:" >&2
            echo "  All fields are case-sensitive and must match exactly:" >&2
            echo "  1. Organization/User: JSONbored (must match GitHub org/username exactly)" >&2
            echo "  2. Repository: safemocker (just the repo name, or JSONbored/safemocker)" >&2
            echo "  3. Workflow filename: publish-release.yml (must include .yml extension)" >&2
            echo "" >&2
            echo "Current workflow values:" >&2
            echo "  - Repository: ${{ github.repository }}" >&2
            echo "  - Workflow file: publish-release.yml" >&2
            echo "" >&2
            echo "Note: npm does not verify trusted publisher configuration when you save it." >&2
            echo "Errors only appear when you attempt to publish." >&2
            echo "" >&2
            echo "See: https://docs.npmjs.com/trusted-publishers/" >&2
            exit 1
          fi
          
          echo "âœ… Published @jsonbored/safemocker@$VERSION to npm"

      - name: Verify npm publish
        run: |
          set -e  # Exit on error
          
          VERSION="${{ steps.version.outputs.VERSION }}"
          
          echo "ðŸ” DEBUG: Verifying package is published on npm..."
          
          # Wait a moment for npm registry to update
          sleep 2
          
          # Verify package exists on npm
          if ! npm view "@jsonbored/safemocker@$VERSION" version > /dev/null 2>&1; then
            echo "âŒ Error: Package not found on npm after publish" >&2
            echo "ðŸ” DEBUG: Attempted to verify: @jsonbored/safemocker@$VERSION" >&2
            echo "ðŸ” DEBUG: This may indicate the publish failed or npm registry hasn't updated yet" >&2
            exit 1
          fi
          
          PUBLISHED_VERSION=$(npm view "@jsonbored/safemocker@$VERSION" version)
          echo "âœ… Verified: @jsonbored/safemocker@$PUBLISHED_VERSION is published on npm"

      - name: Extract changelog for version
        id: changelog
        run: |
          set -e  # Exit on error
          
          VERSION="${{ steps.version.outputs.VERSION }}"
          
          echo "ðŸ” DEBUG: Extracting changelog section for version $VERSION..."
          
          if [ ! -f CHANGELOG.md ]; then
            echo "âš ï¸ CHANGELOG.md not found, creating placeholder"
            echo "No significant changes for this release." > /tmp/release-notes.md
            echo "notes_path=/tmp/release-notes.md" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Extract the version section from CHANGELOG.md
          # Find the line with [VERSION] and extract until the next version section or end of file
          # Skip empty lines and link definitions at the bottom
          CHANGELOG_SECTION=$(awk -v version="${VERSION}" '
            BEGIN { found=0; content_found=0; in_section=0 }
            /^## \[/ {
              if (found) exit  # Found next version section, stop
              if (index($0, "[" version "]") > 0) {
                found=1
                in_section=1
                next  # Skip the header line itself (we'll add it back)
              }
            }
            found && in_section {
              # Skip link definitions at the bottom (lines starting with [version]:)
              if ($0 ~ /^\[.*\]: /) {
                next
              }
              # Track if we have actual content (non-empty lines)
              if (length($0) > 0) {
                content_found=1
              }
              print
            }
          ' CHANGELOG.md)
          
          # If no content found, create a placeholder
          if [ -z "$CHANGELOG_SECTION" ] || [ -z "$(echo "$CHANGELOG_SECTION" | grep -v '^$')" ]; then
            echo "âš ï¸ No changelog content found for version $VERSION. Creating a placeholder."
            echo "No significant changes for this release." > /tmp/release-notes.md
          else
            # Add the version header back
            echo "## [$VERSION] - $(date +%Y-%m-%d)" > /tmp/release-notes.md
            echo "" >> /tmp/release-notes.md
            echo "$CHANGELOG_SECTION" >> /tmp/release-notes.md
          fi
          
          echo "notes_path=/tmp/release-notes.md" >> $GITHUB_OUTPUT
          
          # Debug: Show what was extracted
          echo "ðŸ” DEBUG: Extracted changelog section (first 10 lines):"
          head -10 /tmp/release-notes.md || echo "(empty)"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          tag_name: ${{ steps.version.outputs.TAG }}
          name: ${{ steps.version.outputs.TAG }}
          body_path: ${{ steps.changelog.outputs.notes_path }}
          generate_release_notes: false
          draft: false
          prerelease: false
          # If release exists, this will update it (make_release_latest: true ensures it becomes the latest)
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        if: always()
        run: |
          echo "## âœ… Release Published" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ steps.version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** ${{ steps.version.outputs.TAG }}" >> $GITHUB_STEP_SUMMARY
          echo "- **npm Package:** @jsonbored/safemocker@${{ steps.version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **GitHub Release:** [View Release](https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.TAG }})" >> $GITHUB_STEP_SUMMARY

